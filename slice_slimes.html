<!DOCTYPE html>
<html>
<body style="background:#0f0f0f;color:#fff;font-family:sans-serif;padding:20px">
<h2>Slime Sheet ‚Üí Individual Transparent PNGs</h2>

<input type="file" id="file" accept="image/*"><br><br>

<button id="zipBtn" style="display:none">‚¨áÔ∏è Download All as ZIP</button>
<button id="galleryBtn" style="display:none">üñºÔ∏è Open Download Gallery</button>

<br><br>

<div id="out" style="display:grid;grid-template-columns:repeat(auto-fill,90px);gap:14px"></div>

<canvas id="c" style="display:none"></canvas>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
const cols = 8;
const rows = 6;
const padding = 4;

const fileInput = document.getElementById("file");
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const out = document.getElementById("out");

const zipBtn = document.getElementById("zipBtn");
const galleryBtn = document.getElementById("galleryBtn");

let images = []; // store {name, dataUrl}

fileInput.onchange = () => {
  const img = new Image();
  img.onload = ()=>process(img);
  img.src = URL.createObjectURL(fileInput.files[0]);
};

function process(img){
  out.innerHTML = "";
  images = [];

  const cellW = img.width/cols;
  const cellH = img.height/rows;

  let index = 1;

  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      canvas.width = cellW;
      canvas.height = cellH;
      ctx.clearRect(0,0,cellW,cellH);
      ctx.drawImage(img,c*cellW,r*cellH,cellW,cellH,0,0,cellW,cellH);

      // remove black background
      const d = ctx.getImageData(0,0,cellW,cellH);
      for(let i=0;i<d.data.length;i+=4){
        const R=d.data[i],G=d.data[i+1],B=d.data[i+2];
        if(R<10 && G<10 && B<10) d.data[i+3]=0;
      }
      ctx.putImageData(d,0,0);

      const trimmed = trim(canvas);
      const url = trimmed.toDataURL("image/png");
      const name = `slime${index}.png`;
      images.push({name, url});
      index++;

      const imgEl = document.createElement("img");
      imgEl.src = url;
      imgEl.style.width="80px";
      imgEl.style.height="80px";
      imgEl.style.objectFit="contain";
      imgEl.title = name + " ‚Äî right-click to save";
      out.appendChild(imgEl);
    }
  }

  // enable buttons
  zipBtn.style.display = "inline-block";
  galleryBtn.style.display = "inline-block";
}

// ===== ZIP DOWNLOAD =====
zipBtn.onclick = async () => {
  const zip = new JSZip();
  const folder = zip.folder("slime_icons");

  for(const img of images){
    const base64 = img.url.split(",")[1];
    folder.file(img.name, base64, {base64:true});
  }

  const blob = await zip.generateAsync({type:"blob"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "slime_icons.zip";
  a.click();
};

// ===== GALLERY DOWNLOAD MODE =====
galleryBtn.onclick = () => {
  out.innerHTML = "";

  images.forEach(img=>{
    const el = document.createElement("img");
    el.src = img.url;
    el.style.width="80px";
    el.style.height="80px";
    el.style.objectFit="contain";
    el.style.cursor="pointer";
    el.title = "Click to download " + img.name;

    el.onclick = () => {
      const a = document.createElement("a");
      a.href = img.url;
      a.download = img.name;
      a.click();
    };

    out.appendChild(el);
  });
};

function trim(src){
  const w=src.width,h=src.height;
  const d=src.getContext("2d").getImageData(0,0,w,h).data;
  let x1=w,y1=h,x2=0,y2=0;
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    const a=d[(y*w+x)*4+3];
    if(a>5){ if(x<x1)x1=x; if(y<y1)y1=y; if(x>x2)x2=x; if(y>y2)y2=y; }
  }
  const cw=Math.max(1,(x2-x1)+1+padding*2);
  const ch=Math.max(1,(y2-y1)+1+padding*2);
  const out=document.createElement("canvas");
  out.width=cw; out.height=ch;
  out.getContext("2d").drawImage(src,x1-padding,y1-padding,cw,ch,0,0,cw,ch);
  return out;
}
</script>
</body>
</html>
